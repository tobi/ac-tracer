name: Build and Release

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Content Manager compatible package
        run: |
          # Create the folder structure for Content Manager drag & drop
          # CSP Lua apps go in: assettocorsa/apps/lua/<AppName>/
          mkdir -p package/apps/lua/traces/tracks

          # Copy core Lua modules
          cp traces.lua package/apps/lua/traces/
          cp state.lua package/apps/lua/traces/
          cp lap.lua package/apps/lua/traces/
          cp lap_telemetry.lua package/apps/lua/traces/
          cp corner_analysis.lua package/apps/lua/traces/
          cp app_settings.lua package/apps/lua/traces/
          cp corner.lua package/apps/lua/traces/
          cp scoring.lua package/apps/lua/traces/

          # Copy configuration files
          cp manifest.ini package/apps/lua/traces/
          cp settings.ini package/apps/lua/traces/

          # Copy icons
          cp icon.png package/apps/lua/traces/
          cp icon_corners.png package/apps/lua/traces/
          cp icon_main.png package/apps/lua/traces/
          cp icon_telemetry.png package/apps/lua/traces/

          # Copy tracks template (only the corners template, not sample data)
          cp tracks/corners.csv package/apps/lua/traces/tracks/

          # Create the zip file from within the package directory
          cd package
          zip -r ../ac-tracer.zip apps

      - name: Delete existing release
        run: |
          gh release delete latest --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Release
          body: |
            ## AC Tracer - Content Manager Compatible Package

            **Installation:** Drag and drop `ac-tracer.zip` into Content Manager to install.

            This release is automatically updated on every push to master.
          files: ac-tracer.zip
          make_latest: true
